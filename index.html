<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D.sk – Outreach Dashboard</title>
  <style>
    :root { --gap: 16px; --pad: 20px; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; color: #111; background: #fafafa; }
    header { padding: var(--pad); background: #fff; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 10; }
    h1 { font-size: 24px; margin: 0 0 6px; }
    .sub { color:#6b7280; font-size: 14px; }
    main { max-width: 1200px; margin: 0 auto; padding: var(--pad); }
    .grid { display: grid; gap: var(--gap); }
    .cards { grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .kpi { font-size: 34px; font-weight: 700; margin: 8px 0 0; }
    .muted { color:#6b7280; font-size: 13px; }
    nav.tabs { display:flex; gap:8px; margin: 24px 0; flex-wrap: wrap; }
    nav.tabs button { border:1px solid #e5e7eb; background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    nav.tabs button.active { background:#111; color:#fff; border-color:#111; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom: 1px solid #f0f0f0; padding:10px; text-align:left; vertical-align: top; }
    th { background:#fcfcfc; position: sticky; top: 64px; z-index: 5; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; }
    .stage-queued { background:#fff7ed; border-color:#fdba74; }
    .stage-phase1_sent { background:#eef2ff; border-color:#c7d2fe; }
    .stage-phase2_sent { background:#ecfeff; border-color:#a5f3fc; }
    .stage-phase3_sent { background:#f0fdf4; border-color:#bbf7d0; }
    .stage-replied { background:#ecfdf5; border-color:#6ee7b7; }
    .notice { background:#fff; border:1px solid #fde68a; border-left:6px solid #f59e0b; padding:14px; border-radius:10px; }
    .footer { color:#9ca3af; font-size:12px; margin-top:32px; }
    a.link { color:#2563eb; text-decoration:none; }
    details.debug { margin-top:24px; }
    pre { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <h1>3D.sk Outreach Dashboard</h1>
    <div class="sub">Live data from Google Sheets → Contacts_Public (read-only). Messages in EN. Limits: 30 Phase 1/day, 60–120 s pauses.</div>
  </header>
  <main>
    <section class="grid cards" id="kpis">
      <div class="card"><div class="muted">Contacts total</div><div class="kpi" id="k_total">–</div></div>
      <div class="card"><div class="muted">Phase 1 sent</div><div class="kpi" id="k_p1">–</div></div>
      <div class="card"><div class="muted">Phase 2 sent (Original)</div><div class="kpi" id="k_p2">–</div></div>
      <div class="card"><div class="muted">Phase 2 sent (Pro)</div><div class="kpi" id="k_p2pro">–</div></div>
      <div class="card"><div class="muted">Phase 3 sent</div><div class="kpi" id="k_p3">–</div></div>
      <div class="card"><div class="muted">Replies</div><div class="kpi" id="k_rep">–</div></div>
    </section>

    <nav class="tabs" id="tabs"></nav>
    <section id="view"></section>

    <details class="debug">
      <summary>Debug</summary>
      <div id="dbg"></div>
    </details>

    <div class="footer">© 3D.sk – Outreach. Data source: Google Sheets (Contacts_Public CSV). Credentials for Pro accounts are never exposed here.</div>
  </main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZOSOSxfS-YBKi0GNNDJ4FkwX1yNkg47Wivbb1936rkHiFabJ98rerOsOEdlZ2WFzxr2R5J0ZWWp2p/pub?gid=0&single=true&output=csv";

const normStr = s => String(s ?? "").replace(/\uFEFF/g,"").trim();
const stageOf = r => normStr(r.stage).toLowerCase();
const tmplOf  = r => (normStr(r.template_set).toLowerCase() || 'original');

/* ---------- CSV loader ---------- */
async function loadCSV(url){
  const res = await fetch(url, { cache: "no-store" });
  let text = await res.text();
  text = text.replace(/^\uFEFF/, "");

  const lines = text.trim().split(/\r?\n/);
  const headerLine = lines.shift() || "";
  const headersRaw = parseCSVLine(headerLine);

  const canonical = [
    "id","full_name","first_name","role","linkedin_url","stage",
    "sent_phase1_at","sent_phase2_at","sent_phase3_at",
    "reply1_at","reply1_note","reply2_at","reply2_note","reply3_at","reply3_note",
    "template_set","evidence"
  ];

  const normHeader = s => normStr(s).toLowerCase().replace(/[^a-z0-9_]+/g,"");
  const canonicalMap = new Map(canonical.map(k => [normHeader(k), k]));
  const mapByName = headersRaw.map(h => canonicalMap.get(normHeader(h)) || null);

  const matched = mapByName.filter(Boolean).length;
  const useOrderFallback = matched < Math.ceil(headersRaw.length * 0.5);
  const map = useOrderFallback
    ? headersRaw.map((_, i) => canonical[i] || null)
    : mapByName;

  const rows = lines.map(parseCSVLine).map(cols => {
    const obj = {};
    map.forEach((key, i) => {
      if (!key) return;
      let v = (cols[i] ?? "");
      v = v.replace(/^"|"$/g, "");
      v = normStr(v);
      obj[key] = v;
    });
    return obj;
  });

  // Debug
  const dbg = document.getElementById('dbg');
  if (dbg) {
    const counts = {
      queued: rows.filter(r=>stageOf(r)==='queued').length,
      p1:     rows.filter(r=>stageOf(r)==='phase1_sent').length,
      p2o:    rows.filter(r=>stageOf(r)==='phase2_sent' && tmplOf(r)==='original').length,
      p2p:    rows.filter(r=>stageOf(r)==='phase2_sent' && tmplOf(r)==='pro').length,
      p3:     rows.filter(r=>stageOf(r)==='phase3_sent').length,
      replied:rows.filter(r=>stageOf(r)==='replied').length,
    };
    dbg.innerHTML =
      `<p><b>headersRaw</b>: ${escapeHTML(JSON.stringify(headersRaw))}</p>` +
      `<p><b>map</b>: ${escapeHTML(JSON.stringify(map))}</p>` +
      `<p><b>rows.length</b>: ${rows.length}</p>` +
      `<p><b>counts</b>: ${escapeHTML(JSON.stringify(counts))}</p>` +
      (rows[0] ? `<pre>${escapeHTML(JSON.stringify(rows[0], null, 2))}</pre>` : '');
  }

  return rows;
}

/* CSV line parser (quotes aware) */
function parseCSVLine(line){
  const out = []; let cur = ''; let q=false;
  for (let i=0;i<line.length;i++){
    const c=line[i];
    if (q){
      if (c==='"' && line[i+1]==='"'){ cur+='"'; i++; }
      else if (c=== '"'){ q=false; }
      else cur+=c;
    } else {
      if (c=== ','){ out.push(cur); cur=''; }
      else if (c=== '"'){ q=true; }
      else cur+=c;
    }
  }
  out.push(cur);
  return out;
}

function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function countKPIs(rows){
  const total = rows.length;
  const p1 = rows.filter(r=>stageOf(r)==='phase1_sent').length;
  const p2 = rows.filter(r=>stageOf(r)==='phase2_sent' && tmplOf(r)==='original').length;
  const p2pro = rows.filter(r=>stageOf(r)==='phase2_sent' && tmplOf(r)==='pro').length;
  const p3 = rows.filter(r=>stageOf(r)==='phase3_sent').length;
  const replied = rows.filter(r=>stageOf(r)==='replied').length;
  return { total, p1, p2, p2pro, p3, replied };
}

function fmtStage(stage){
  const s = stageOf({stage});
  return `<span class="badge stage-${s}">${s || '—'}</span>`;
}
function safe(v, fallback=''){ return (v && String(v).trim().length ? v : fallback); }

function renderKpis(k){
  document.getElementById('k_total').textContent = k.total;
  document.getElementById('k_p1').textContent = k.p1;
  document.getElementById('k_p2').textContent = k.p2;
  document.getElementById('k_p2pro').textContent = k.p2pro;
  document.getElementById('k_p3').textContent = k.p3;
  document.getElementById('k_rep').textContent = k.replied;
}

function renderTable(rows){
  const cols = [
    ['id','ID'],['full_name','Name'],['role','Role'],['linkedin_url','LinkedIn'],
    ['stage','Stage'],['sent_phase1_at','P1 at'],['sent_phase2_at','P2 at'],['sent_phase3_at','P3 at'],
    ['reply1_at','Reply1 at'],['reply1_note','Reply1 note'],['reply2_at','Reply2 at'],['reply2_note','Reply2 note'],
    ['reply3_at','Reply3 at'],['reply3_note','Reply3 note'],['template_set','Template']
  ];

  const container = document.getElementById('view');
  container.innerHTML = '';
  const wrapper = document.createElement('div');
  wrapper.className = 'card';
  wrapper.style.overflow = 'auto';

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  cols.forEach(([,label])=>{
    const th = document.createElement('th');
    th.textContent = label;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');

  rows.forEach((r, idx) => {
    const tr = document.createElement('tr');
    cols.forEach(([key])=>{
      let v = r[key];
      if (key==='id') v = safe(v, String(idx+1));
      if (key==='full_name') v = safe(v, '(no name)');
      const td = document.createElement('td');
      if (key==='linkedin_url' && v){
        const a = document.createElement('a');
        a.href = v; a.target = '_blank'; a.className='link'; a.textContent='profile';
        td.appendChild(a);
      } else if (key==='stage'){
        td.innerHTML = fmtStage(r.stage);
      } else {
        td.textContent = v || '';
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  wrapper.appendChild(table);
  container.appendChild(wrapper);

  // istotná diagnostika
  container.dataset.renderedRows = rows.length;
  if (!rows.length){
    const diag = document.createElement('div');
    diag.className = 'notice';
    diag.innerHTML = '<b>No rows to display.</b> Filter returned 0 rows.';
    container.appendChild(diag);
  }
}

function renderTabs(rows){
  const tabs = [
    {id:'all', label:'All'},
    {id:'queued', label:'Queued'},
    {id:'p1', label:'Phase 1 sent'},
    {id:'p2o', label:'Phase 2 Original'},
    {id:'p2p', label:'Phase 2 Pro'},
    {id:'p3', label:'Phase 3 sent'},
    {id:'replied', label:'Replied'}
  ];
  const el = document.getElementById('tabs');
  el.innerHTML = '';
  tabs.forEach(t=>{
    const btn = document.createElement('button');
    btn.textContent = t.label;
    btn.onclick = ()=>{
      [...el.children].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      let filtered = rows;
      if (t.id==='queued') filtered = rows.filter(r=>stageOf(r)==='queued');
      if (t.id==='p1')     filtered = rows.filter(r=>stageOf(r)==='phase1_sent');
      if (t.id==='p2o')    filtered = rows.filter(r=>stageOf(r)==='phase2_sent' && tmplOf(r)==='original');
      if (t.id==='p2p')    filtered = rows.filter(r=>stageOf(r)==='phase2_sent' && tmplOf(r)==='pro');
      if (t.id==='p3')     filtered = rows.filter(r=>stageOf(r)==='phase3_sent');
      if (t.id==='replied')filtered = rows.filter(r=>stageOf(r)==='replied');
      renderTable(filtered);
    };
    el.appendChild(btn);
  });

  // 1) Programový klik
  if (el.firstChild) el.firstChild.click();
}

/* ---------- init ---------- */
(async function init(){
  try{
    const rows = await loadCSV(CSV_URL);
    renderKpis(countKPIs(rows));
    renderTabs(rows);

    // 2) Priamy render (pre istotu) – ak by programový klik neprebehol
    renderTable(rows);

    // 3) Overenie – ak tabuľka stále nemá riadky, logni varovanie
    const rendered = Number(document.getElementById('view').dataset.renderedRows || 0);
    if (!rendered && rows.length){
      console.warn('Rendered 0 rows, but rows exist. Forcing render again.');
      renderTable(rows);
    }
  }catch(err){
    document.getElementById('view').innerHTML =
      `<div class="notice"><b>Failed to load data.</b><br>${escapeHTML(err)}</div>`;
    console.error(err);
  }
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D.sk – Outreach Dashboard</title>
  <style>
    :root { --gap: 16px; --pad: 20px; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; color: #111; background: #fafafa; }
    header { padding: var(--pad); background: #fff; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 10; }
    h1 { font-size: 24px; margin: 0 0 6px; }
    .sub { color:#6b7280; font-size: 14px; }
    main { max-width: 1200px; margin: 0 auto; padding: var(--pad); }
    .grid { display: grid; gap: var(--gap); }
    .cards { grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .kpi { font-size: 34px; font-weight: 700; margin: 8px 0 0; }
    .muted { color:#6b7280; font-size: 13px; }
    nav.tabs { display:flex; gap:8px; margin: 24px 0; flex-wrap: wrap; }
    nav.tabs button { border:1px solid #e5e7eb; background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    nav.tabs button.active { background:#111; color:#fff; border-color:#111; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom: 1px solid #f0f0f0; padding:10px; text-align:left; vertical-align: top; }
    th { background:#fcfcfc; position: sticky; top: 64px; z-index: 5; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; }
    .stage-queued { background:#fff7ed; border-color:#fdba74; }
    .stage-phase1_sent { background:#eef2ff; border-color:#c7d2fe; }
    .stage-phase2_sent { background:#ecfeff; border-color:#a5f3fc; }
    .stage-phase3_sent { background:#f0fdf4; border-color:#bbf7d0; }
    .stage-replied { background:#ecfdf5; border-color:#6ee7b7; }
    .notice { background:#fff; border:1px solid #fde68a; border-left:6px solid #f59e0b; padding:14px; border-radius:10px; }
    .footer { color:#9ca3af; font-size:12px; margin-top:32px; }
    a.link { color:#2563eb; text-decoration:none; }
  </style>
</head>
<body>
  <header>
    <h1>3D.sk Outreach Dashboard</h1>
    <div class="sub">Live data from Google Sheets → Contacts_Public (read-only). Messages in EN. Limits: 30 Phase 1/day, 60–120 s pauses.</div>
  </header>
  <main>
    <section class="grid cards" id="kpis">
      <div class="card"><div class="muted">Contacts total</div><div class="kpi" id="k_total">–</div></div>
      <div class="card"><div class="muted">Phase 1 sent</div><div class="kpi" id="k_p1">–</div></div>
      <div class="card"><div class="muted">Phase 2 sent (Original)</div><div class="kpi" id="k_p2">–</div></div>
      <div class="card"><div class="muted">Phase 2 sent (Pro)</div><div class="kpi" id="k_p2pro">–</div></div>
      <div class="card"><div class="muted">Phase 3 sent</div><div class="kpi" id="k_p3">–</div></div>
      <div class="card"><div class="muted">Replies</div><div class="kpi" id="k_rep">–</div></div>
    </section>

    <nav class="tabs" id="tabs"></nav>
    <section id="view"></section>

    <div class="footer">© 3D.sk – Outreach. Data source: Google Sheets (Contacts_Public CSV). Credentials for Pro accounts are never exposed here.</div>
  </main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZOSOSxfS-YBKi0GNNDJ4FkwX1yNkg47Wivbb1936rkHiFabJ98rerOsOEdlZ2WFzxr2R5J0ZWWp2p/pub?gid=0&single=true&output=csv";

/* --- Robustné načítanie CSV s mapovaním hlavičiek na kanonické názvy --- */
async function loadCSV(url){
  const res = await fetch(url, { cache: "no-store" });
  let text = await res.text();

  // odstráň BOM
  text = text.replace(/^\uFEFF/, "");

  const lines = text.trim().split(/\r?\n/);
  const headerLine = lines.shift() || "";
  const headersRaw = parseCSVLine(headerLine);

  // kanonické kľúče, ktoré používame v aplikácii
  const canonical = [
    "id","full_name","first_name","role","linkedin_url","stage",
    "sent_phase1_at","sent_phase2_at","sent_phase3_at",
    "reply1_at","reply1_note","reply2_at","reply2_note","reply3_at","reply3_note",
    "template_set","evidence"
  ];

  // normalizačná funkcia (lowercase, bez ne-alfanumerických znakov a podčiarkovníkov)
  const norm = s => String(s)
    .replace(/\uFEFF/g,"")
    .replace(/^"|"$/g,"")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9_]+/g,""); // odstráni medzery, pomlčky, atď.

  const canonicalMap = new Map(canonical.map(k => [norm(k), k]));

  // namapuj index -> kanonický kľúč (ak nájdeme zhodu)
  const mapIndexToKey = headersRaw.map(h => {
    const n = norm(h);
    return canonicalMap.get(n) || null;
  });

  const rows = lines.map(parseCSVLine).map(cols => {
    const obj = {};
    mapIndexToKey.forEach((key, i) => {
      if (!key) return; // neznáma hlavička – ignoruj
      const v = (cols[i] ?? "").replace(/^"|"$/g, "");
      obj[key] = v;
    });
    return obj;
  });

  return rows;
}

/* CSV line parser, rešpektuje čiarky v úvodzovkách */
function parseCSVLine(line){
  const out = []; let cur = ''; let q=false;
  for (let i=0;i<line.length;i++){
    const c=line[i];
    if (q){
      if (c==='"' && line[i+1]==='"'){ cur+='"'; i++; }
      else if (c=== '"'){ q=false; }
      else cur+=c;
    } else {
      if (c=== ','){ out.push(cur); cur=''; }
      else if (c=== '"'){ q=true; }
      else cur+=c;
    }
  }
  out.push(cur);
  return out;
}

function countKPIs(rows){
  const total = rows.length;
  const p1 = rows.filter(r=>r.stage==='phase1_sent').length;
  const p2 = rows.filter(r=>r.stage==='phase2_sent' && (r.template_set||'original')==='original').length;
  const p2pro = rows.filter(r=>r.stage==='phase2_sent' && r.template_set==='pro').length;
  const p3 = rows.filter(r=>r.stage==='phase3_sent').length;
  const replied = rows.filter(r=>r.stage==='replied').length;
  return { total, p1, p2, p2pro, p3, replied };
}

function fmtStage(stage){ return `<span class="badge stage-${stage}">${stage}</span>`; }

function renderKpis(k){
  document.getElementById('k_total').textContent = k.total;
  document.getElementById('k_p1').textContent = k.p1;
  document.getElementById('k_p2').textContent = k.p2;
  document.getElementById('k_p2pro').textContent = k.p2pro;
  document.getElementById('k_p3').textContent = k.p3;
  document.getElementById('k_rep').textContent = k.replied;
}

function renderTable(rows){
  const cols = [
    ['id','ID'],['full_name','Name'],['role','Role'],['linkedin_url','LinkedIn'],
    ['stage','Stage'],['sent_phase1_at','P1 at'],['sent_phase2_at','P2 at'],['sent_phase3_at','P3 at'],
    ['reply1_at','Reply1 at'],['reply1_note','Reply1 note'],['reply2_at','Reply2 at'],['reply2_note','Reply2 note'],
    ['reply3_at','Reply3 at'],['reply3_note','Reply3 note'],['template_set','Template']
  ];
  let html = '<div class="card" style="overflow:auto">\n<table><thead><tr>' + cols.map(c=>`<th>${c[1]}</th>`).join('') + '</tr></thead><tbody>';
  for (const r of rows){
    html += '<tr>' + cols.map(([k,label])=>{
      let v = r[k]||'';
      if(k==='linkedin_url' && v) v = `<a class="link" href="${v}" target="_blank">profile</a>`;
      if(k==='stage') v = fmtStage(r[k]||'');
      return `<td>${v}</td>`;
    }).join('') + '</tr>';
  }
  html += '</tbody></table></div>';
  document.getElementById('view').innerHTML = html;
}

function renderTabs(rows){
  const tabs = [
    {id:'all', label:'All'},
    {id:'queued', label:'Queued'},
    {id:'p1', label:'Phase 1 sent'},
    {id:'p2o', label:'Phase 2 Original'},
    {id:'p2p', label:'Phase 2 Pro'},
    {id:'p3', label:'Phase 3 sent'},
    {id:'replied', label:'Replied'}
  ];
  const el = document.getElementById('tabs');
  el.innerHTML = '';
  tabs.forEach(t=>{
    const btn = document.createElement('button');
    btn.textContent = t.label;
    btn.onclick = ()=>{
      [...el.children].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      let filtered = rows;
      if (t.id==='queued') filtered = rows.filter(r=>r.stage==='queued');
      if (t.id==='p1') filtered = rows.filter(r=>r.stage==='phase1_sent');
      if (t.id==='p2o') filtered = rows.filter(r=>r.stage==='phase2_sent' && (r.template_set||'original')==='original');
      if (t.id==='p2p') filtered = rows.filter(r=>r.stage==='phase2_sent' && r.template_set==='pro');
      if (t.id==='p3') filtered = rows.filter(r=>r.stage==='phase3_sent');
      if (t.id==='replied') filtered = rows.filter(r=>r.stage==='replied');
      renderTable(filtered);
    };
    el.appendChild(btn);
  });
  el.firstChild.classList.add('active');
}

(async function init(){
  try{
    const rows = await loadCSV(CSV_URL);
    const k = countKPIs(rows);
    renderKpis(k);
    renderTabs(rows);
    renderTable(rows);
  }catch(err){
    document.getElementById('view').innerHTML = `<div class="notice"><b>Failed to load data.</b><br>${err}</div>`;
    console.error(err);
  }
})();
</script>
</body>
</html>
